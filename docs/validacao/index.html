<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Valida√ß√£o de Produ√ß√µes - INCT NanoAgro</title>
  <link rel="stylesheet" href="metricas-inct.css">
  <style>
    :root {
      color-scheme: light dark;
      --bg: #f0f7ef; --panel: #ffffff; --ink: #1a2e18; --muted: #557052;
      --accent: #284C23; --danger: #8a1f17; --border: #d1e0d0;
      --table-row-even: rgba(40, 76, 35, 0.04); --table-hover: rgba(40, 76, 35, 0.07); --meta-bg: #f9fff8;
    }
    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #112210; --panel: #1a2e18; --ink: #d1d9d0; --muted: #7a9477;
        --accent: #4caf50; --danger: #ff8a80; --border: #2c422a;
        --table-row-even: rgba(255, 255, 255, 0.03); --table-hover: rgba(255, 255, 255, 0.06); --meta-bg: var(--panel);
      }
    }
    * { box-sizing: border-box; }
    body { margin: 0; padding: 24px; font-family: "Helvetica", "Arial", sans-serif; background: var(--bg); color: var(--ink); line-height: 1.5; }
    h1 { color: var(--ink) !important; font-weight: 600; margin: 0 0 8px; }
    h2, h3 { color: var(--ink); font-weight: 600; margin: 0 0 8px; }
    .muted, #source-line { color: var(--muted); font-size: 13px; }
    a { color: var(--accent); text-decoration: none; font-weight: 600; }
    a:hover { text-decoration: underline; }

    .page-header { display: flex; align-items: center; gap: 20px; padding: 16px 20px; border: 1px solid var(--border); background: var(--panel); color: var(--ink); }
    .logo-container { display: flex; align-items: center; justify-content: center; height: 80px; width: auto; max-width: 250px; overflow: hidden; }
    .logo-container img { height: 140%; width: auto; object-fit: contain; }

    .sticky-header { position: sticky; top: 0; z-index: 100; background: var(--panel); border-bottom: 2px solid var(--border); box-shadow: 0 4px 12px rgba(0,0,0,0.1); padding: 12px 20px; margin: 0 -24px 12px -24px; }
    .meta-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px; }
    .meta-card { padding: 10px 12px; border: 1px solid var(--border); background: var(--meta-bg); }
    .meta-card span { display: block; font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.05em; }
    .meta-card strong { display: block; font-size: 15px; color: var(--ink); }

    .actions { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; margin-top: 12px; }
    .actions button, .actions a { padding: 8px 16px; font-size: 13px; cursor: pointer; border: 1px solid var(--accent); background: transparent; color: var(--accent); border-radius: 4px; font-weight: 600; }
    #export-validation { background: var(--accent); color: var(--bg); border: none; }
    #add-production-btn { background: var(--muted); color: var(--bg); border: none; }

    #download-json, #print-btn, #list-link, #add-production-btn { display: none !important; }
    .reveal-all #download-json, .reveal-all #print-btn, .reveal-all #list-link, .reveal-all #add-production-btn { display: inline-block !important; }

    .panel { margin-top: 20px; padding: 16px 20px; border: 1px solid var(--border); background: var(--panel); }
    .filters { display: grid; gap: 16px; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
    .filter-group { display: grid; gap: 6px; }
    .filter-title { font-size: 11px; text-transform: uppercase; color: var(--muted); font-weight: bold; }
    
    table { width: 100%; border-collapse: collapse; margin-top: 16px; background: rgba(255, 255, 255, 0.02); }
    th, td { border: 1px solid var(--border); padding: 10px 12px; vertical-align: top; font-size: 13px; }
    th { background: var(--panel); color: var(--ink); text-transform: uppercase; font-size: 10px; letter-spacing: 0.05em; text-align: left; position: sticky; top: 132px; z-index: 1; }
    tbody tr { cursor: pointer; }
    tbody tr:nth-child(even) { background: var(--table-row-even); }
    tbody tr:hover { background: var(--table-hover); }
    
    .section-header { display: flex; align-items: center; justify-content: space-between; margin-top: 40px; padding-bottom: 8px; border-bottom: 1px solid var(--border); }
    .add-to-section-btn { display: none !important; background: var(--accent); color: var(--bg); border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 10px; font-weight: bold; text-transform: uppercase; }
    .reveal-all .add-to-section-btn { display: inline-block !important; }
    .hidden-col { display: none !important; }
    .reveal-all .hidden-col { display: table-cell !important; }

    .back-to-top-btn { position: fixed; bottom: 40px; left: 50%; transform: translateX(-50%); background: var(--ink); color: var(--bg); padding: 12px 24px; border-radius: 40px; cursor: pointer; z-index: 10000; box-shadow: 0 8px 32px rgba(0,0,0,0.4); display: none; align-items: center; gap: 10px; font-weight: bold; }
    .backdoor-dot { position: fixed; bottom: 10px; right: 10px; cursor: pointer; z-index: 9999; font-size: 20px; opacity: 0.8; }
    
    .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: none; place-items: center; z-index: 20000; padding: 20px; }
    .modal-card { background: var(--panel); padding: 24px; border: 1px solid var(--border); border-radius: 8px; width: 100%; max-width: 600px; }
    
    footer { margin-top: 120px; padding: 60px 24px; background: var(--panel); border-top: 1px solid var(--border); display: flex; flex-direction: column; align-items: center; gap: 20px; text-align: center; }
    .footer-logo img { height: 70px; }
    .flash { animation: flash-bg 0.8s ease; }
    @keyframes flash-bg { 0% { background: rgba(40, 76, 35, 0.3); } 100% { background: transparent; } }
  </style>
</head>
<body>
  <div id="auth-modal" class="modal"><div class="modal-card" style="max-width: 320px;"><h4>Acesso Administrativo</h4><div style="position:relative;display:flex;align-items:center;"><input type="password" id="auth-pass" placeholder="Chave" style="width:100%;padding:10px;background:var(--bg);color:var(--ink);border:1px solid var(--border);"><span id="auth-eye" style="position:absolute;right:10px;cursor:pointer;">üëÅÔ∏è</span></div><div style="display:flex;justify-content:flex-end;gap:10px;margin-top:20px;"><button onclick="document.getElementById('auth-modal').style.display='none'">Cancelar</button><button id="auth-submit" style="background:var(--accent);color:var(--bg)">Entrar</button></div></div></div>
  <header class="page-header"><div class="logo-container"><img src="../assets/logo-nanoagro.png"></div><div class="header-title"><h1>Valida√ß√£o de Produ√ß√µes</h1><div id="source-line" class="muted"></div></div></header>
  <div class="sticky-header"><div class="meta-grid"><div class="meta-card"><span>Pesquisador</span><strong id="researcher-name">--</strong></div><div class="meta-card"><span>Lattes ID</span><strong id="researcher-id">--</strong></div><div class="meta-card"><span>Extra√ß√£o</span><strong id="extracted-at">--</strong></div><div class="meta-card"><span>Total</span><strong id="total-productions">--</strong></div></div><div class="actions"><button id="add-production-btn" onclick="openAddModal()">+ Adicionar Produ√ß√£o</button><button id="export-validation" onclick="downloadValidationJson()">Baixar valida√ß√£o (JSON)</button><a id="download-json" href="#" target="_blank">JSON original</a><button id="print-btn" onclick="window.print()">Print</button><a id="list-link" href="lista.html">√çndice</a></div></div>
  <section class="panel"><div class="filters"><div class="filter-group"><span class="filter-title">Ano</span><div id="year-filters" class="filter-options"></div></div><div class="filter-group"><span class="filter-title">Busca</span><input id="search-input" type="search" placeholder="T√≠tulo, ve√≠culo..." oninput="applyFilters()" style="background:var(--bg);color:var(--ink);border:1px solid var(--border);padding:8px;"/></div></div></section>
  <section id="summary-panel" class="panel"><h2>Sum√°rio por se√ß√£o</h2><ul id="summary-list"></ul></section>
  <div id="productions-container"></div>
  <footer><div class="footer-logo"><img src="../assets/logo-nanoagro.png"></div><div class="footer-info"><strong>INCT NanoAgro</strong><br>UNESP - Campus Sorocaba<br>&copy; 2026 INCT NanoAgro.</div></footer>
  <div id="add-modal" class="modal"><div class="modal-card"><h3>Injetar Produ√ß√£o</h3><div style="display:grid;gap:12px;"><input id="add-tipo" type="text" readonly style="background:rgba(0,0,0,0.1)"><input id="add-titulo" type="text" placeholder="T√≠tulo"><input id="add-veiculo" type="text" placeholder="Ve√≠culo"><input id="add-ano" type="number"><input id="add-doi" type="text" placeholder="DOI"><textarea id="add-autores" placeholder="Autores" rows="3"></textarea></div><div style="display:flex;justify-content:flex-end;gap:10px;margin-top:20px;"><button onclick="document.getElementById('add-modal').style.display='none'">Cancelar</button><button onclick="saveManual()" style="background:var(--accent);color:var(--bg)">Injetar</button></div></div></div>
  <div id="edit-modal" class="modal"><div class="modal-card"><h3>Editar</h3><div style="display:grid;gap:12px;"><input id="edit-titulo" type="text"><input id="edit-veiculo" type="text"><input id="edit-ano" type="number"><input id="edit-doi" type="text"><textarea id="edit-autores" rows="3"></textarea></div><div style="display:flex;justify-content:flex-end;gap:10px;margin-top:20px;"><button onclick="clearEdits()">Limpar</button><button onclick="document.getElementById('edit-modal').style.display='none'">Cancelar</button><button onclick="saveEdit()" style="background:var(--accent);color:var(--bg)">Salvar</button></div></div></div>
  <div id="bd-trigger" class="backdoor-dot">‚öôÔ∏è</div>

  <script>
    const state = { raw: [], selections: {}, edits: {}, key: null, sections: [], ek: null, researcher: null };
    const BD_KEY = 'inct_admin_authorized';
    const BD_PASS = 'nanoagro2026';

    const load = async () => {
      const p = new URLSearchParams(location.search).get('prefill'); if(!p) return;
      const d = await (await fetch(`../prefill/${p}`)).json();
      state.raw = d.productions; state.researcher = d.researcher || {}; state.key = `inct_v5::${state.researcher.lattes_id || p}`;
      document.getElementById('researcher-name').textContent = state.researcher.full_name || '--';
      document.getElementById('researcher-id').textContent = state.researcher.lattes_id || '--';
      document.getElementById('extracted-at').textContent = d.metadata?.extracted_at || '--';
      document.getElementById('total-productions').textContent = d.productions.length;
      document.getElementById('source-line').textContent = `Fonte: ${p}`;
      const saved = localStorage.getItem(state.key);
      if(saved) { const parsed = JSON.parse(saved); state.selections = parsed.s||{}; state.edits = parsed.e||{}; }
      else { state.raw.forEach((i, idx) => state.selections[i.fingerprint_sha1 || `${i.production_type || 'Outros'}::${idx}`] = true); }
      state.sections = [...new Set(state.raw.map(i => i.production_type || i.section || 'Outros'))];
      renderSummary(); renderYears(); applyFilters();
    };

    const renderSummary = () => {
      const l = document.getElementById('summary-list'); l.innerHTML = '';
      state.sections.forEach(s => {
        const li = document.createElement('li'); const a = document.createElement('a'); a.textContent = s; a.href='#';
        a.onclick = (e) => { e.preventDefault(); const t = document.getElementById(`sec-${s.toLowerCase().replace(/\s+/g,'-')}`); window.scrollTo({top: t.offsetTop-132, behavior:'auto'}); showBTT(); };
        li.appendChild(a); l.appendChild(li);
      });
    };

    const showBTT = () => {
      let b = document.getElementById('ephemeral-btt'); if(!b){ b=document.createElement('div'); b.id='ephemeral-btt'; b.className='back-to-top-btn'; b.innerHTML='<span>‚¨ÜÔ∏è</span> VOLTAR AO SUM√ÅRIO'; document.body.appendChild(b); b.onclick=()=>{window.scrollTo({top:document.getElementById('summary-panel').offsetTop-132, behavior:'auto'}); b.style.display='none';}; }
      b.style.display='flex'; setTimeout(()=>window.onscroll=()=>{if(window.scrollY<200){b.style.display='none'; window.onscroll=null;}}, 1000);
    };

    const renderYears = () => {
      const c = document.getElementById('year-filters'); c.innerHTML = '';
      [...new Set(state.raw.map(i=>i.ano||i.year))].filter(Boolean).sort().forEach(y => {
        const l = document.createElement('label'); l.style.marginRight='10px'; l.innerHTML = `<input type="checkbox" value="${y}" checked onchange="applyFilters()"> ${y}`;
        c.appendChild(l);
      });
    };

    const applyFilters = () => {
      const q = document.getElementById('search-input').value.toLowerCase();
      const ys = new Set([...document.querySelectorAll('#year-filters input:checked')].map(i=>i.value));
      renderTables(state.raw.filter(i => ys.has(String(i.ano||i.year)) && (!q || `${i.titulo} ${i.veiculo} ${i.autores}`.toLowerCase().includes(q))));
    };

    const renderTables = (items) => {
      const cont = document.getElementById('productions-container'); cont.innerHTML = '';
      state.sections.forEach(cat => {
        const si = items.filter(i => (i.production_type||i.section||'Outros') === cat); if(!si.length) return;
        const id = `sec-${cat.toLowerCase().replace(/\s+/g,'-')}`; const s = document.createElement('section');
        
        const allChecked = si.every((i) => state.selections[i.fingerprint_sha1 || `${cat}::${state.raw.indexOf(i)}`]);

        s.innerHTML = `<div class="section-header" id="${id}"><h2>${cat} (${si.length})</h2><div class="section-controls"><label><input type="checkbox" ${allChecked?'checked':''} onchange="toggleSec('${cat}', this.checked)"> Selecionar tudo</label><button class="add-to-section-btn" onclick="openAddModal('${cat}')">+ Adicionar</button></div></div>
        <table><thead><tr><th>INCT?</th><th>Ano</th><th>T√≠tulo</th><th>Ve√≠culo</th><th>Autores</th><th class="hidden-col">DOI</th><th class="hidden-col">Fingerprint</th><th class="hidden-col">A√ß√µes</th></tr></thead><tbody></tbody></table>`;
        const b = s.querySelector('tbody');
        si.forEach(i => {
          const k = i.fingerprint_sha1 || `${cat}::${state.raw.indexOf(i)}`; const d = state.edits[k] ? {...i, ...state.edits[k]} : i;
          const r = document.createElement('tr');
          r.onclick = (e) => {
            if (e.target.tagName === 'BUTTON' || e.target.tagName === 'A' || e.target.type === 'checkbox') return;
            state.selections[k] = !state.selections[k]; save(); applyFilters();
          };
          r.innerHTML = `<td><input type="checkbox" ${state.selections[k]?'checked':''} onchange="state.selections['${k}']=this.checked; save(); applyFilters();"></td><td>${d.ano||d.year||''}</td><td><strong>${d.titulo}</strong></td><td>${d.veiculo||d.journal||''}</td><td>${d.autores||''}</td><td class="hidden-col">${d.doi||''}</td><td class="hidden-col"><code style="font-size:10px">${i.fingerprint_sha1||'N/A'}</code></td><td class="hidden-col"><button onclick="openEdit('${k}')">Editar</button></td>`;
          b.appendChild(r);
        });
        cont.appendChild(s);
      });
    };

    const save = () => localStorage.setItem(state.key, JSON.stringify({s: state.selections, e: state.edits}));
    window.toggleSec = (c, v) => { state.raw.forEach((i, idx) => { if((i.production_type||i.section||'Outros')===c) state.selections[i.fingerprint_sha1 || `${c}::${idx}`]=v; }); save(); applyFilters(); };
    window.openAddModal = (t) => { document.getElementById('add-tipo').value = t||'Artigos'; document.getElementById('add-modal').style.display='grid'; };
    window.saveManual = () => { const k = 'man-'+Date.now(); state.raw.unshift({production_type: document.getElementById('add-tipo').value, titulo: document.getElementById('add-titulo').value, ano: document.getElementById('add-ano').value, fingerprint_sha1: k}); state.selections[k]=true; save(); document.getElementById('add-modal').style.display='none'; applyFilters(); };
    window.openEdit = (k) => { state.ek = k; const i = state.raw.find(x=>(x.fingerprint_sha1||`${x.production_type || 'Outros'}::${state.raw.indexOf(x)}`)===k)||state.edits[k]||{}; document.getElementById('edit-titulo').value=i.titulo||''; document.getElementById('edit-veiculo').value=item.veiculo||''; document.getElementById('edit-ano').value=item.ano||''; document.getElementById('edit-doi').value=item.doi||''; document.getElementById('edit-autores').value=item.autores||''; document.getElementById('edit-modal').style.display='grid'; };
    window.saveEdit = () => { state.edits[state.ek] = { titulo: document.getElementById('edit-titulo').value, veiculo: document.getElementById('edit-veiculo').value, ano: document.getElementById('edit-ano').value, doi: document.getElementById('edit-doi').value, autores: document.getElementById('edit-autores').value }; save(); document.getElementById('edit-modal').style.display='none'; applyFilters(); };
    window.downloadValidationJson = () => { 
        const items = state.raw.map((i, idx) => { const k = i.fingerprint_sha1 || `${i.production_type || 'Outros'}::${idx}`; return { fingerprint_sha1: i.fingerprint_sha1, selected: !!state.selections[k], titulo: i.titulo, ano: i.ano, edits: state.edits[k]||null }; });
        const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify({researcher: state.researcher, items}, null, 2)], {type:'application/json'})); 
        const namePart = (state.researcher.full_name || 'export').toLowerCase().replace(/\s+/g, '-');
        const lattesId = state.researcher.lattes_id || '0000000000000000';
        a.download = `${lattesId}__${namePart}__validado.json`; 
        a.click();
    };
    document.getElementById('bd-trigger').onclick = () => { if(localStorage.getItem(BD_KEY)==='true') document.body.classList.toggle('reveal-all'); else document.getElementById('auth-modal').style.display='grid'; };
    document.getElementById('auth-submit').onclick = () => { if(document.getElementById('auth-pass').value===BD_PASS){ localStorage.setItem(BD_KEY,'true'); document.body.classList.add('reveal-all'); document.getElementById('auth-modal').style.display='none'; } else alert('Erro'); };
    const eye = document.getElementById('auth-eye'); eye.onmousedown = () => document.getElementById('auth-pass').type='text'; eye.onmouseup = eye.onmouseleave = () => document.getElementById('auth-pass').type='password';
    load();
  </script>
</body>
</html>
