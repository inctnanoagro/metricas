<!doctype html>
<html lang="pt-BR">
    <head>
        <meta charset="UTF-8" />
        <title>Ingestão Institucional – INCT NanoAgro</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                max-width: 900px;
                margin: auto;
            }
            h1 {
                margin-top: 20px;
            }
            label {
                font-weight: bold;
                display: block;
                margin-top: 15px;
            }
            textarea,
            input,
            select {
                width: 100%;
                padding: 6px;
                margin-top: 5px;
            }
            button {
                margin-top: 10px;
                padding: 6px 10px;
            }
            .item {
                border: 1px solid #ccc;
                padding: 10px;
                margin-top: 10px;
            }
            .item input {
                margin-bottom: 5px;
            }
            .readonly input {
                background: #f5f5f5;
                border: 1px solid #ddd;
            }
            .actions button {
                margin-right: 5px;
            }
        </style>
    </head>
    <body>
        <h1>Ingestão Institucional – INCT NanoAgro</h1>

        <label>Pesquisador</label>
        <input id="pesquisador" value="Leonardo Fernandes Fraceto" />

        <label>Período</label>
        <input id="periodo" value="2024-2025" />

        <label>Categoria</label>
        <select id="categoria">
            <option value="artigo">Artigos em periódicos</option>
            <option value="capitulo">Capítulos de livro</option>
            <option value="livro">Livros</option>
            <option value="evento">Trabalhos em eventos</option>
            <option value="orientacao">Orientações</option>
        </select>

        <label>Produção (1 por linha)</label>
        <textarea id="entrada" rows="4"></textarea>

        <button onclick="adicionar()">Adicionar</button>

        <h2>Produções adicionadas</h2>
        <div id="lista"></div>

        <button onclick="baixarJSON()">Baixar JSON pré-carregado</button>

        <script>
            let producoes = [];

            function parseLinha(linha, categoria) {
                // normaliza quebras de linha e espaços
                const s = linha.replace(/\s+/g, " ").trim();

                // remove bloco de citações no fim
                const semCit = s.replace(/\s*Citações:.*$/i, "").trim();

                // ano
                const anos = semCit.match(/\b(19|20)\d{2}\b/g);
                const ano = anos ? parseInt(anos[anos.length - 1], 10) : null;

                // DOI (se existir)
                const doiMatch = semCit.match(
                    /10\.\d{4,9}\/[-._;()/:A-Z0-9]+/i,
                );
                const doi = doiMatch ? doiMatch[0].toLowerCase() : null;

                // 1) Separar AUTORES do RESTO usando o padrão do Lattes: " . " (ponto com espaços)
                //    Ex.: "... ; ROCHA, C. Q. . Zein Nanoparticles..."
                const split = semCit.split(/\s\.\s/, 2);
                const autoresRaw = (split[0] || "").trim();
                const resto = (split[1] || "").trim();

                // autores (separados por ;)
                const autores = autoresRaw
                    .split(";")
                    .map((a) => a.trim())
                    .filter((a) => a.length > 2)
                    .join("; ");

                // 2) Título: pega do início do resto até antes do periódico (caixa alta + ", v.")
                //    Ex.: "Zein ... Applications. PHARMACEUTICS, v. 16, p. 1603, 2024."
                let titulo = resto;
                const mVeic = resto.match(
                    /\.\s+([A-Z0-9][A-Z0-9\s\-&]+),\s*v\.\s*\d+/,
                );
                if (mVeic && mVeic.index !== undefined) {
                    titulo = resto.slice(0, mVeic.index).trim();
                } else {
                    // fallback: primeiro ponto final
                    const p = resto.indexOf(".");
                    if (p > 0) titulo = resto.slice(0, p).trim();
                }

                // remove ponto final do título (se sobrou)
                titulo = titulo.replace(/\.*\s*$/, "").trim();

                return {
                    categoria,
                    titulo: titulo || null,
                    autores: autores || null,
                    ano,
                    doi,
                    vinculo_inct: null,
                };
            }

            function adicionar() {
                const texto = document.getElementById("entrada").value.trim();
                if (!texto) return;

                const categoria = document.getElementById("categoria").value;
                const item = parseLinha(texto, categoria);

                producoes.push(item);
                document.getElementById("entrada").value = "";
                render();
            }

            function render() {
                const lista = document.getElementById("lista");
                lista.innerHTML = "";

                producoes.forEach((p, i) => {
                    const div = document.createElement("div");
                    div.className = "item readonly";

                    div.innerHTML = `
      <label>Título</label>
      <input value="${p.titulo}">
      <label>Autores</label>
      <input value="${p.autores}">
      <label>Ano</label>
      <input value="${p.ano ?? ""}">
      <label>DOI</label>
      <input value="${p.doi ?? ""}">
      <div class="actions">
        <button onclick="editar(${i})">Editar</button>
        <button onclick="remover(${i})">Remover</button>
      </div>
    `;
                    lista.appendChild(div);
                });
            }

            function editar(i) {
                const div = document.getElementsByClassName("item")[i];
                div.classList.remove("readonly");

                const btns = div.querySelector(".actions");
                btns.innerHTML = `
    <button onclick="salvar(${i})">Salvar</button>
  `;
            }

            function salvar(i) {
                const div = document.getElementsByClassName("item")[i];
                const inputs = div.querySelectorAll("input");

                producoes[i].titulo = inputs[0].value;
                producoes[i].autores = inputs[1].value;
                producoes[i].ano = inputs[2].value
                    ? parseInt(inputs[2].value)
                    : null;
                producoes[i].doi = inputs[3].value || null;

                render();
            }

            function remover(i) {
                producoes.splice(i, 1);
                render();
            }

            function baixarJSON() {
                const data = {
                    pesquisador: document.getElementById("pesquisador").value,
                    periodo: document.getElementById("periodo").value,
                    producoes,
                };

                const blob = new Blob([JSON.stringify(data, null, 2)], {
                    type: "application/json",
                });

                const a = document.createElement("a");
                a.href = URL.createObjectURL(blob);
                a.download = `prefill_${data.pesquisador.replace(/\s+/g, "_")}.json`;
                a.click();
            }
        </script>
    </body>
</html>
