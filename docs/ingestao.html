<!doctype html>
<html lang="pt-BR">
    <head>
        <meta charset="UTF-8" />
        <title>Ingestão Institucional – INCT NanoAgro</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                max-width: 900px;
                margin: auto;
            }
            h1 {
                margin-top: 20px;
            }
            label {
                font-weight: bold;
                display: block;
                margin-top: 15px;
            }
            textarea,
            input,
            select {
                width: 100%;
                padding: 6px;
                margin-top: 5px;
            }
            button {
                margin-top: 10px;
                padding: 6px 10px;
            }
            .item {
                border: 1px solid #ccc;
                padding: 10px;
                margin-top: 10px;
            }
            .item input {
                margin-bottom: 5px;
            }
            .readonly input {
                background: #f5f5f5;
                border: 1px solid #ddd;
            }
            .actions button {
                margin-right: 5px;
            }
        </style>
    </head>
    <body>
        <h1>Ingestão Institucional – INCT NanoAgro</h1>

        <label>Pesquisador</label>
        <input id="pesquisador" value="Leonardo Fernandes Fraceto" />

        <label>Período</label>
        <input id="periodo" value="2024-2025" />

        <label>Categoria</label>
        <select id="categoria">
            <option value="artigo">Artigos em periódicos</option>
            <option value="capitulo">Capítulos de livro</option>
            <option value="livro">Livros</option>
            <option value="evento">Trabalhos em eventos</option>
            <option value="orientacao">Orientações</option>
        </select>

        <label>Produção (1 por linha)</label>
        <textarea id="entrada" rows="4"></textarea>

        <button onclick="adicionar()">Adicionar</button>

        <h2>Produções adicionadas</h2>
        <div id="lista"></div>

        <button onclick="baixarJSON()">Baixar JSON pré-carregado</button>

        <script>
            let producoes = [];

            /* ============================
           Utils
        ============================ */

            function splitMultiplasProducoes(texto) {
                return texto
                    .split(/\n\s*\d+\.\s*\n|<div class="artigo-completo"/i)
                    .map((t) => t.trim())
                    .filter((t) => t.length > 30)
                    .map((t) =>
                        t.startsWith("<div")
                            ? t
                            : '<div class="artigo-completo">' + t,
                    );
            }

            function isHtmlArtigo(input) {
                return (
                    input.includes("artigo-completo") ||
                    input.includes("icone-doi")
                );
            }

            /* ============================
           Parser HTML Lattes
        ============================ */

            function parseArtigoHTML(html, categoria) {
                const wrapper = document.createElement("div");
                wrapper.innerHTML = html;

                // DOI
                const doiLink = wrapper.querySelector("a.icone-doi");
                const doi = doiLink
                    ? doiLink.href.replace(/^https?:\/\/(dx\.)?doi\.org\//, "")
                    : null;

                // Ano
                const anoSpan = wrapper.querySelector(
                    '[data-tipo-ordenacao="ano"]',
                );
                const ano = anoSpan
                    ? parseInt(anoSpan.textContent.trim(), 10)
                    : null;

                // Texto limpo (sem spans de ordenação)
                const clone = wrapper.cloneNode(true);
                clone
                    .querySelectorAll(
                        "[data-tipo-ordenacao], .icone-doi, .citado, sup, img",
                    )
                    .forEach((e) => e.remove());

                let texto = clone.textContent.replace(/\s+/g, " ").trim();

                // Remove prefixo "38. "
                texto = texto.replace(/^\d+\.\s*/, "");

                // Split autores / resto
                const partes = texto.split(/\s\.\s/, 2);

                let autores = partes[0] || null;
                if (autores) {
                    autores = autores
                        .split(";")
                        .map((a) => a.trim())
                        .filter((a) => a.length > 2)
                        .join("; ");
                }

                // Resto → título + periódico
                let resto = partes[1] || "";

                // Veículo, volume e páginas
                let veiculo = null,
                    volume = null,
                    paginas = null;

                const veicMatch = resto.match(
                    /\.?\s*([A-Z0-9][A-Z0-9\s\-&]+),\s*v\.\s*([\dA-Za-z]+),\s*p\.\s*([\d\-–]+)/,
                );
                if (veicMatch) {
                    veiculo = veicMatch[1].trim();
                    volume = veicMatch[2];
                    paginas = veicMatch[3];
                }

                // Título = antes do veículo
                let titulo = resto;
                if (veicMatch && veicMatch.index !== undefined) {
                    titulo = resto.slice(0, veicMatch.index).trim();
                }
                titulo = titulo.replace(/\.*$/, "");

                return {
                    categoria,
                    titulo: titulo || null,
                    autores,
                    ano,
                    veiculo,
                    volume,
                    paginas,
                    doi,
                    vinculo_inct: null,
                };
            }

            /* ============================
           Fallback texto simples
        ============================ */

            function parseLinha(texto, categoria) {
                return {
                    categoria,
                    titulo: texto,
                    autores: null,
                    ano: null,
                    veiculo: null,
                    volume: null,
                    paginas: null,
                    doi: null,
                    vinculo_inct: null,
                };
            }

            /* ============================
           Ingestão
        ============================ */

            function ingestaoAvancada(input, categoria) {
                const blocos = splitMultiplasProducoes(input);
                const resultados = [];

                blocos.forEach((bloco) => {
                    if (isHtmlArtigo(bloco)) {
                        resultados.push(parseArtigoHTML(bloco, categoria));
                    } else {
                        resultados.push(parseLinha(bloco, categoria));
                    }
                });

                return resultados;
            }

            function adicionar() {
                const texto = document.getElementById("entrada").value.trim();
                const categoria = document.getElementById("categoria").value;
                if (!texto) return;

                const novos = ingestaoAvancada(texto, categoria);
                novos.forEach((p) => producoes.push(p));

                document.getElementById("entrada").value = "";
                render();
            }

            /* ============================
           Render / Download
        ============================ */

            function render() {
                const lista = document.getElementById("lista");
                lista.innerHTML = "";

                producoes.forEach((p, i) => {
                    const div = document.createElement("div");
                    div.className = "item readonly";
                    div.innerHTML = `
              <label>Título</label><input value="${p.titulo || ""}">
              <label>Autores</label><input value="${p.autores || ""}">
              <label>Ano</label><input value="${p.ano || ""}">
              <label>Veículo</label><input value="${p.veiculo || ""}">
              <label>Volume</label><input value="${p.volume || ""}">
              <label>Páginas</label><input value="${p.paginas || ""}">
              <label>DOI</label><input value="${p.doi || ""}">
              <div class="actions">
                <button onclick="editar(${i})">Editar</button>
                <button onclick="remover(${i})">Remover</button>
              </div>
            `;
                    lista.appendChild(div);
                });
            }

            function editar(i) {
                const div = document.getElementsByClassName("item")[i];
                div.classList.remove("readonly");
                div.querySelector(".actions").innerHTML =
                    `<button onclick="salvar(${i})">Salvar</button>`;
            }

            function salvar(i) {
                const inputs = document
                    .getElementsByClassName("item")
                    [i].querySelectorAll("input");
                [
                    "titulo",
                    "autores",
                    "ano",
                    "veiculo",
                    "volume",
                    "paginas",
                    "doi",
                ].forEach(
                    (k, idx) => (producoes[i][k] = inputs[idx].value || null),
                );
                producoes[i].ano = producoes[i].ano
                    ? parseInt(producoes[i].ano)
                    : null;
                render();
            }

            function remover(i) {
                producoes.splice(i, 1);
                render();
            }

            function baixarJSON() {
                const data = {
                    pesquisador: document.getElementById("pesquisador").value,
                    periodo: document.getElementById("periodo").value,
                    producoes,
                };
                const blob = new Blob([JSON.stringify(data, null, 2)], {
                    type: "application/json",
                });
                const a = document.createElement("a");
                a.href = URL.createObjectURL(blob);
                a.download = `prefill_${data.pesquisador.replace(/\s+/g, "_")}.json`;
                a.click();
            }
        </script>
    </body>
</html>
